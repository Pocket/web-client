# Snowplow Events

This doc is not exhaustive, but lays out how we work with Snowplow on this repo.

_This doc is a work in progress. Some things are definitely missing... for now..._

# Overview

We use Snowplow to capture user analytics in our front-end code. Snowplow is our 3rd party tracking system that offers some automatic tracking and a full suite of customizable events.

For full documentation of Snowplow please refer to the [official docs](https://docs.snowplow.io/docs)

## Folder Structure

- `actions`: Where every action is defined
- `entities`: Builds an entity to attach to each event
- `events`: Builds the event to send

## Anatomy of a Request

### Schema

The schema is essentially the version number of the event/entity requirements. That way the data team can update the structure/requirements without it having downstream effects.

When initializing events we define the schema used with our `getSchemaUri` function. This defaults to a `1-0-0` version number.

An example of how/why we may update the schema we‚Äôre using: The initial version of the ui schema had a limited number of components; `button`, `dialog`, `menu`, `card`, `list`, and `screen`. This schema was updated to add additional components, including a `link` component. In order to be able to use this `link` component, we need to point to the updated schema; `1-0-2`.

### Events

- `Pageview`: this event is fired every page view. Happens automatically in web-client whenever it detects a path change.

- `Page Ping`: tracks the length of time a user views a page. Happens automatically every 10 seconds.

- `link_click`: tracks any link clicked on a page. Happens automatically. Does not apply to links rendered after initial page load.

- `*_form`: tracks interactions on a form field in the page. Consists of focus_form, change_form, submit_form. Happens automatically. Does not apply to form fields rendered after initial page load.

- `impression`: when an element comes into view.

- `engagement`: when a user clicks on an element.

- `content_open`: when a user clicks an item, usually in a card element, sometimes a link within an article.

- `variant_enroll`: when the application enrolls a user in a test. Happens automatically. _(NOTE: The analytics team has requested that we update this event to only fire when a user would typically see the experiement, not on page load)_

### Entities

Attached to each snowplow event are an array of Entities. Some are included automatically with every request sent (`user` and `api_user`).

- `api_user`: Identifies a user with a hashed id generated by the backend. Includes the version number of the application. Included automatically on every event.

- `content`: Represents a unique piece of content within Pocket. Always includes a `url`, often includes an `item_id`.

- `corpus_recommendation`: Describes a content recommendation. Should be included with any impression or engagement events with recommendations. Always includes a `corpus_recommendation_id`.

- `feature_flag`: Included with the variant_enroll event. Contains the name of the experiment and the variant the user is enrolled to. There must always be a control value as a variant.

- `newsletter_subscriber`: Sent when a user signs up for the Pocket Hits newsletter.

- `recommendation`: Represents a recommendation item from the RecsAPI endpoint. Always includes a `recommendation_id` and a position/index.

- `report`: Used when a user reports an article on our Explore/Discover pages as being inappropriate.

- `slate_lineup`: Identifies a group of slates from the RecsAPI endpoint.

- `slate`: Identifies a group of recommendations from the RecsAPI endpoint.

- `ui`: Describes an element in the user interface. Should be included with any impression, engagement, or custom engagement events.

- `user`: Describes a user based on available identifiers. At a minimum contains a session id, and a user id (if the user is logged in)

# How to Read Defined Events

All analytics events are defined in the `actions` folder. Each file should correlate to a section in the application.

For example: imagine you want to know which event and entities are tracked when a user saves an item on Home. Let's take a look at the event below (stored in the `./actions/home.js` file) and break down all the parts:

```
  'home.corpus.save': {
    eventType: 'engagement',
    entityTypes: ['content', 'ui', 'corpusRecommendation'],
    eventData: {
      engagementType: 'save',
      uiType: 'button'
    },
    expects: ['corpusRecommendationId', 'url'],
    description: 'Click ‚ÄúSave‚Äù on a card in baseline home'
  }
```

The first line in the event is the descriptive key which is also used as the `identifier` for `ui` entities.

When this event is sent off to Snowplow, it defines the `eventType` as `engagement` and the `entityTypes` included with this event are `content`, `ui`, and `corpus_recommendation`. These are the event and entities respectively.

Some data included with events and entities are hardcoded and will never change. This data is defined in the `eventData` object. The save event outlined in the paragraph above has the`engagementType`and `uiType` passed in.

Variable data is defined in the `expects` array. We use this array to make sure that all the required info is passed when sending this event. If an event is fired without all the required data points defined in the `expects` array, a `console.warning` is fired in dev environments, or a Sentry error is sent when on production.

The `description` key is optional and is only used by developers to help add context when trying to read through defined events.

# Developing With Snowplow

## Initialization

Snowplow is initialized at the top level of the application. This happens once per application load, and will only occur once the logged in/out status of the user has been determined, whether OneTrust has finished loading, and we have a `sess_guid`.

Initialization is where we enable automatic link tracking, form tracking, the heartbeat (`link_click`, `*_form`, and `Page Ping`, respectively), and define the entities to include on every request (`api_user` and `user`).

This is also when any stored user data is cleared if a user has opted out of analytics cookies.

### Configuration

There are two different configurations when initializing Snowplow depending on whether the user has opted out of analytics cookies (via the OneTrust integration).

The difference between the two determines how events are sent, and whether to use local storage for user data.

By default all events are sent with the `eventMethod` set to `beacon`. This means that even if a user leaves the application, events can still finish being sent in the background. If an event doesn't complete the send, it will occur when the user returns to the application. User info and unsent events are stored in local storage and cookies (with `stateStorageStrategy` set to `cookieAndLocalStorage`)

When a user has opted out of using analytics cookies, the `eventMethod` is set to `post`. This guarantees that the event is fired before the user is able to navigate away from the page and won't happen in the background. Instead of full user info being sent `anonymousTracking` is turned on with `withServerAnonymisation` set to `true`. `stateStorageStrategy`is set to`none`.

### Dev vs Production

There‚Äôs a couple key differences between how we initialize Snowplow in our dev environments vs production. When we‚Äôre in a local environment, we use a different `appId`, send the events to a different endpoint, and load a different Snowplow javascript file. If you take a look at our `common/constants.js` file, you‚Äôll see we have a few different environment specific variables. The `process.env.SHOW_DEV === 'included'` that we check for is what determines dev vs production. That variable is set in the run dev script in the `package.json` file, and happens automatically depending on how you start the application from your terminal (`npm run dev` vs `npm run start`)

_NOTE: Ad Blockers will prevent Snowplow from sending events in our development environment. It‚Äôs best to disable these blockers on getpocket.com_

We are also able to run tests using Snowplow micro. _*TODO: More info to come on this*_

### Do Not Track

We currently initialize Snowplow with the `respectDoNotTrack` parameter set to false. Most modern browsers have a setting that allows users to ask web sites to not track them. While this may feel counter to Mozilla‚Äôs mission, the Data Team found that we were unable to capture any Snowplow events when we respected this parameter, resulting in TONS of lost data.

## How Requests Are Sent

...

## How to Add New Events

...

If you send an event with an `identifier` that isn't in one of these `actions` files, you'll get a nasty error in your console üíÄ

## How to Add New Entities or Events

...

### Recommendations

The data and analytics team has asked that all `ui` entities with an `indentifier` that contains the word `home`, `discover`, or `rec` means that this event is tied to a recommendation.
